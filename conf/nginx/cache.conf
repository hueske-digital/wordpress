# FastCGI Cache Configuration for WordPress

# Cache path and zone configuration
fastcgi_cache_path /var/cache/nginx levels=1:2 keys_zone=WORDPRESS:100m inactive=60m max_size=1g;
fastcgi_cache_key "$scheme$request_method$host$request_uri";

# Cache bypass conditions
map $request_uri $skip_cache {
    default 0;
    # Don't cache admin area
    ~*/wp-admin/ 1;
    ~*/wp-json/ 1;
    # Don't cache logged in users
    ~*/wp-login.php 1;
    # Don't cache WooCommerce pages
    ~*/cart/ 1;
    ~*/checkout/ 1;
    ~*/my-account/ 1;
}

# Check for logged in users
map $http_cookie $skip_cache_cookie {
    default 0;
    # WordPress logged in cookie
    "~*wordpress_logged_in_" 1;
    # WooCommerce cookies
    "~*woocommerce_items_in_cart" 1;
    "~*woocommerce_cart_hash" 1;
    "~*wp_woocommerce_session_" 1;
    # Comment cookies
    "~*comment_author_" 1;
    "~*comment_author_email_" 1;
}

# Combine skip conditions
map $skip_cache$skip_cache_cookie $skip_cache_final {
    default 1;
    "00" 0;
}

# Cache status for debugging (add to response headers)
map $upstream_cache_status $cache_status {
    default $upstream_cache_status;
    '' "BYPASS";
}